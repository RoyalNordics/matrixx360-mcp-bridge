{
  "version": "4.1",
  "name": "MatriXx360 Auto-Runner Task Plan",
  "spec_reference": "./docs/matrixx360_master_spec.md",
  "policies": {
    "error_contract": {
      "shape": {
        "ok": false,
        "errors": [
          {
            "code": "STRING",
            "field": "STRING|NULL",
            "message": "STRING"
          }
        ]
      },
      "http_mapping": {
        "NOT_FOUND": 404,
        "UNAUTHORIZED": 401,
        "FORBIDDEN": 403,
        "VALIDATION_ERROR": 422,
        "CONFLICT": 409,
        "INTERNAL_ERROR": 500
      }
    },
    "rbac_headers": {
      "tenant": "x-tenant-id",
      "role": "x-user-role"
    },
    "commit_policy": {
      "branch": "main",
      "when": [
        "on_task_complete",
        "on_modified_files>=5"
      ],
      "message_template": "Auto-commit: {id} â€” {title} âœ…"
    },
    "deploy_policy": {
      "enabled": true,
      "trigger": "after_commit",
      "require_coverage_pct": 80
    },
    "test_loop": {
      "typecheck_cmd": "npm run typecheck",
      "test_cmd": "npm run test",
      "max_retries": 3,
      "on_fail": "self_repair_and_retry"
    },
    "frontend_build": "(cd web && npm run build)",
    "summary_policy": {
      "file_path": "docs/BUILD_SUMMARY.md",
      "per_task_entry_template": "### {timestamp} â€” {id} {title}\\n- Phase: {phase}\\n- Status: {status}\\n- Tests: {tests_passed}/{tests_total} green\\n- Coverage: {coverage_pct}%\\n- Files changed: {files_changed}\\n- Commit: {commit_sha}\\n- Notes: {notes}\\n",
      "final_summary_template": "# MatriXx360 Build Summary (So Far)\\n\\n**Current Phase:** {current_phase}\\n**Total Tasks:** {completed_tasks}/{total_tasks} complete\\n**Tests:** {total_green}/{total_tests} green\\n**Coverage:** {coverage_pct}%\\n**Last Commit:** {last_commit_sha}\\n\\n## Recent Entries\\n{recent_entries}\\n\\n## Open Issues\\n{open_issues}\\n"
    }
  },
  "tooling": {
    "commit_tool": "git_commit_and_push",
    "deploy_tool": "render_deploy"
  },
  "tasks": [
    {
      "id": "A1",
      "title": "Bootstrap repository structure",
      "intent": "SÃ¸rg for standard projektstruktur matcher specâ€™en.",
      "steps": [
        "Opret mapper: src/routes, src/controllers, src/middleware, src/utils, src/types, src/tests, src/prisma, docs, web (hvis ikke eksisterer).",
        "TilfÃ¸j README med projektoversigt og hurtig start.",
        "Placer/valider docs/matrixx360_master_spec.md."
      ],
      "files_expect": [
        "README.md",
        "docs/matrixx360_master_spec.md"
      ],
      "run": [
        "npm install",
        "npm run typecheck || true"
      ],
      "assert": [
        "SÃ¸rg for at alle mapper findes.",
        "README har Quick Start og Development-sektion."
      ]
    },
    {
      "id": "A2",
      "title": "Prisma schema v1 (multi-tenant core)",
      "intent": "DefinÃ©r tenants, customers, locations, vendors, documents, service modules, transitions.",
      "steps": [
        "Design prisma/schema.prisma i overensstemmelse med spec_reference.",
        "Alle tabelrÃ¦kker skal have tenantId (FK til Tenant) for isolation.",
        "TilfÃ¸j nÃ¸dvendige enumâ€™er: ModuleStatus, DocStatus, VendorStatus, TransitionStatus, Criticality.",
        "SÃ¦t relations, cascading der hvor sikkert og restrictive ellers."
      ],
      "files_expect": [
        "src/prisma/schema.prisma"
      ],
      "run": [
        "npx prisma generate",
        "npx prisma migrate dev --name init",
        "npm run typecheck"
      ],
      "assert": [
        "Prisma migrates uden fejl.",
        "Alle nÃ¸glemodeller og enumâ€™er findes."
      ]
    },
    {
      "id": "A3",
      "title": "Seed data v1",
      "intent": "Realistisk FM seed: Ã©n tenant, 1â€“2 customers, locations, vendors (PREFERRED/APPROVED), service modules, transitions.",
      "steps": [
        "TilfÃ¸j src/prisma/seed.ts med realistiske data fra spec.",
        "IndsÃ¦t minimum Ã©t modul pr. lokation og matching vendor competencies.",
        "SÃ¸rg for docStatus varierer (OK, MISSING, EXPIRED, PENDING)."
      ],
      "files_expect": [
        "src/prisma/seed.ts"
      ],
      "run": [
        "npm run db:seed || node ./src/prisma/seed.ts",
        "npm run typecheck"
      ],
      "assert": [
        "Seed indsÃ¦tter data uden runtime-fejl.",
        "Mindst 1 ACTIVE modul eksisterer."
      ]
    },
    {
      "id": "B1",
      "title": "Express bootstrap + server",
      "intent": "OpsÃ¦t Express server, middlewares, health route, prisma client init.",
      "steps": [
        "Opret src/index.ts med app, health-check GET /health.",
        "TilfÃ¸j prisma client og graceful shutdown.",
        "TilfÃ¸j cors, json body parser, request id."
      ],
      "files_expect": [
        "src/index.ts",
        "src/middleware/requestId.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run dev & sleep 2; kill %1 || true"
      ],
      "assert": [
        "GET /health returnerer 200.",
        "Typecheck uden fejl."
      ]
    },
    {
      "id": "B2",
      "title": "Auth & RBAC middleware",
      "intent": "Header-baseret tenant/role validering og scoping.",
      "steps": [
        "ImplementÃ©r middleware for x-tenant-id og x-user-role.",
        "Afvis manglende/ugyldige headers med 401/403 i error_contract format.",
        "TilfÃ¸j helper som automatisk filtrerer requests pÃ¥ tenantId i alle repo-kald."
      ],
      "files_expect": [
        "src/middleware/auth.ts",
        "src/utils/tenantScope.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test || true"
      ],
      "assert": [
        "Requests uden headers giver 401.",
        "Requests med ugyldig role giver 403."
      ]
    },
    {
      "id": "C1",
      "title": "Error handling pipeline",
      "intent": "Global errorMap â†’ {ok:false, errors:[...]}; Zodâ†’422; notFoundâ†’404.",
      "steps": [
        "TilfÃ¸j asyncHandler, validate(zodSchema) og errorMap som sidste middleware.",
        "Standardiser alle fejl til error_contract.",
        "SÃ¸rg for logisk 404 vs 422 mapping."
      ],
      "files_expect": [
        "src/middleware/errorMap.ts",
        "src/middleware/validate.ts",
        "src/utils/httpErrors.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test || true"
      ],
      "assert": [
        "Valideringsfejl giver 422 med korrekt shape.",
        "Ukendte ressourcer giver 404."
      ]
    },
    {
      "id": "C2",
      "title": "Routes: customers, locations, vendors (CRUD)",
      "intent": "ImplementÃ©r REST-CRUD med Zod validation, tenant-scope og delete-guards.",
      "steps": [
        "Opret routes/controllers for customers, locations og vendors.",
        "IndsÃ¦t FK-checks (fx no orphaned locations).",
        "SÃ¸rg for pagination og filtrering hvor relevant."
      ],
      "files_expect": [
        "src/routes/customers.ts",
        "src/routes/locations.ts",
        "src/routes/vendors.ts",
        "src/controllers/customers.ts",
        "src/controllers/locations.ts",
        "src/controllers/vendors.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "CRUD kaldes succesfuldt i integrationstests.",
        "FK-guards virker (422/409 ved brud)."
      ]
    },
    {
      "id": "C3",
      "title": "Routes: service modules (CRUD + docs + logs)",
      "intent": "Alle servicemodul-operationer inkl. dokumentkrav og servicelog.",
      "steps": [
        "Opret routes/controllers for service modules.",
        "UnderstÃ¸t dokumenters status, nÃ¦ste service og servicelog-historik.",
        "Zod skemaer for creation/update."
      ],
      "files_expect": [
        "src/routes/modules.ts",
        "src/controllers/modules.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "Create/Update/Read/Delete virker med tenant-scope.",
        "Zod fejl â†’ 422 i korrekt format."
      ]
    },
    {
      "id": "C4",
      "title": "Module activation workflow",
      "intent": "POST /modules/:id/activate med readiness-checks.",
      "steps": [
        "ImplementÃ©r readiness: docStatus=OK, primary vendor sat, nÃ¦ste service planlagt >= i dag.",
        "ReturnÃ©r 200 ved success; 422 med domÃ¦nekoder ved brud (fx DOCS_PENDING, PRIMARY_MISSING)."
      ],
      "files_expect": [
        "src/routes/modulesActions.ts",
        "src/services/moduleReadiness.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "Aktivering lykkes pÃ¥ gyldige moduler.",
        "Korrekte domÃ¦nefejlkoder for afviste aktiveringer."
      ]
    },
    {
      "id": "C5",
      "title": "Vendor assignments",
      "intent": "POST /vendors/:id/assignments â€“ match kompetencer, primÃ¦r kun Ã©n.",
      "steps": [
        "Valider kompetence-match til modul kategori.",
        "PrimÃ¦r assignment (ACTIVE) mÃ¥ kun eksistere Ã©n pr. modul.",
        "ReturnÃ©r 201 ved success; 422 'CAPABILITY_MISMATCH'/'PRIMARY_EXISTS'."
      ],
      "files_expect": [
        "src/routes/vendorAssignments.ts",
        "src/controllers/vendorAssignments.ts",
        "src/services/vendorMatch.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "201 ved gyldige assignments.",
        "PrÃ¦cise domÃ¦nefejlkoder ved mismatch/duplikat primÃ¦r."
      ]
    },
    {
      "id": "D1",
      "title": "Dashboard & compliance endpoints",
      "intent": "Aggregator for KPI/SLA, doc-status, overdue services, transition-readiness.",
      "steps": [
        "ImplementÃ©r GET /dashboard/compliance (tenant scoped).",
        "Beregn complianceScore og counters.",
        "TilfÃ¸j CSV export endpoint."
      ],
      "files_expect": [
        "src/routes/dashboard.ts",
        "src/controllers/dashboard.ts",
        "src/utils/csv.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "Compliance svarer med aggregerede nÃ¸gletal.",
        "CSV export returnerer gyldig CSV."
      ]
    },
    {
      "id": "D2",
      "title": "Transitions workflow endpoints",
      "intent": "Opret/track transitions pr. kunde/lokation og gate â€˜READYâ€™.",
      "steps": [
        "POST/GET/PUT /transitions.",
        "READY kun nÃ¥r alle moduler = ACTIVE og docStatus=OK.",
        "ReturnÃ©r 200/422 efter kontrakten."
      ],
      "files_expect": [
        "src/routes/transitions.ts",
        "src/controllers/transitions.ts",
        "src/services/transitionGate.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "Gate-regler hÃ¥ndhÃ¦ves korrekt.",
        "Integrationstests grÃ¸nne."
      ]
    },
    {
      "id": "E1",
      "title": "Settings: categories, validation templates & roles",
      "intent": "Admin endpoints til at styre kategorier og pÃ¥krÃ¦vede felter pr. kategori.",
      "steps": [
        "CRUD for service categories, vendor categories.",
        "Validation templates: requiredFields pr. kategori.",
        "RBAC: kun ADMIN mÃ¥ Ã¦ndre settings."
      ],
      "files_expect": [
        "src/routes/settings.ts",
        "src/controllers/settings.ts"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "ADMIN krÃ¦ves for write.",
        "Templates anvendes i create/update af moduler."
      ]
    },
    {
      "id": "E2",
      "title": "Docs & API reference",
      "intent": "Opdater README og ARCHITECTURE, generÃ©r OpenAPI (om muligt).",
      "steps": [
        "Udbyg README med auth-headers, error contract, flows.",
        "ARCHITECTURE.md med data- og ruteoversigt.",
        "TilfÃ¸j evt. openapi.json (manuelt eller generator)."
      ],
      "files_expect": [
        "README.md",
        "ARCHITECTURE.md",
        "openapi.json"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "Docs beskriver alle moduler og flows.",
        "openapi.json matcher ruter hvis inkluderet."
      ]
    },
    {
      "id": "F1",
      "title": "Web app: scaffold & auth integration",
      "intent": "Vite React TS app med routing, auth-context (headers) og fÃ¦lles UI-komponenter.",
      "steps": [
        "Opret web/ (hvis ikke findes) med Vite React TS.",
        "TilfÃ¸j AuthProvider der sÃ¦tter x-tenant-id og x-user-role.",
        "LÃ¦g UI: Breadcrumbs, StatusBadge, ErrorSummary."
      ],
      "files_expect": [
        "web/index.html",
        "web/src/main.tsx",
        "web/src/App.tsx",
        "web/src/components/*",
        "web/src/providers/AuthProvider.tsx"
      ],
      "run": [
        "cd web && npm install",
        "cd web && npm run build"
      ],
      "assert": [
        "App bygger uden fejl.",
        "Auth headers sendes i fetch-klient."
      ]
    },
    {
      "id": "F2",
      "title": "Web app: pages & flows",
      "intent": "Pages for Customers, Locations, Modules, Vendors, Transitions, Dashboard.",
      "steps": [
        "ImplementÃ©r liste/detalje/edit-sider pr. entitet.",
        "Forms valideres client-side mod samme felter som Zod skemaer (spejling).",
        "Transitions-wizard til READY- gate."
      ],
      "files_expect": [
        "web/src/pages/*",
        "web/src/routes.tsx"
      ],
      "run": [
        "cd web && npm run build"
      ],
      "assert": [
        "Alle sider loader og kan CRUDâ€™e mod API.",
        "Transitions-wizard kan gennemfÃ¸re READY."
      ]
    },
    {
      "id": "F3",
      "title": "E2E tests (Playwright fallback)",
      "intent": "Headless UI-tests af hovedflows (uden â€˜Computer Useâ€™).",
      "steps": [
        "Installer Playwright i web/ og skriv scenarier: create customer â†’ add location â†’ add module â†’ assign vendor â†’ activate â†’ READY.",
        "KÃ¸r i CI-lignende flow lokalt."
      ],
      "files_expect": [
        "web/tests/e2e/*.spec.ts"
      ],
      "run": [
        "cd web && npx playwright install",
        "cd web && npm run test:e2e || npx playwright test"
      ],
      "assert": [
        "Hovedscenarier passerer end-to-end.",
        "Fejl rapporteres med skÃ¦rmbilleder (trace)."
      ]
    },
    {
      "id": "G1",
      "title": "CI hooks (optional)",
      "intent": "TilfÃ¸j GitHub Actions (hvis Ã¸nsket) for typecheck/test/build pÃ¥ push.",
      "steps": [
        "Opret .github/workflows/ci.yml der kÃ¸rer typecheck + test + web build.",
        "Cache node_modules hvor muligt."
      ],
      "files_expect": [
        ".github/workflows/ci.yml"
      ],
      "run": [
        "npm run typecheck",
        "npm run test"
      ],
      "assert": [
        "YAML syntaks korrekt.",
        "Workflow kan kÃ¸re lokalt (tÃ¸r-run)."
      ]
    }
  ],
  "executor": {
    "on_each_task": {
      "sequence": [
        "npm run typecheck",
        "npm run test",
        "(changed_web==true) ? \"(cd web && npm run build)\" : \"echo skip web build\""
      ],
      "if_green_then": [
        "generate_per_task_summary_entry_using(summary_policy.per_task_entry_template) -> append_to(summary_policy.file_path)",
        {
          "tool": "git_commit_and_push",
          "with": {
            "branch": "main",
            "commitMessage": "Auto-commit: {id} â€” {title} âœ…",
            "files": "{all_modified_files_with_full_paths_and_updated_content_including(summary_policy.file_path)}"
          }
        },
        {
          "when": "deploy_policy.enabled==true",
          "tool": "render_deploy",
          "with": {}
        }
      ],
      "if_red_then": [
        "capture_errors_to_notes",
        "generate_per_task_summary_entry_using(summary_policy.per_task_entry_template_with_status_failed) -> append_to(summary_policy.file_path)",
        "attempt_self_repair",
        "retry_up_to_max_retries"
      ]
    },
    "finalize": [
      "generate_final_summary_using(summary_policy.final_summary_template) -> write_to(summary_policy.file_path)",
      {
        "tool": "git_commit_and_push",
        "with": {
          "branch": "main",
          "commitMessage": "Auto-commit: G0 â€” Build Summary update ðŸ“˜",
          "files": "{ensure_includes(summary_policy.file_path)}"
        }
      },
      "echo System Complete",
      "print_changed_files_summary",
      "print_test_summary",
      "print_next_steps"
    ]
  }
}
